name: Deploy Pages

on:
  workflow_dispatch:
    inputs:
      folder_prefix:
        required: false
        default: "branches"
      pr_number:
        required: false
        default: ""
      pr_ref:
        required: false
        default: "head"

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: true

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      subdir: ${{ steps.v.outputs.subdir }}
      checkout_ref: ${{ steps.v.outputs.checkout_ref }}
      mode: ${{ steps.v.outputs.mode }}
    steps:
      - id: v
        shell: bash
        run: |
          PR="${{ github.event.inputs.pr_number }}"
          PR_REF="${{ github.event.inputs.pr_ref }}"
          PREFIX="${{ github.event.inputs.folder_prefix }}"

          if [ -z "$PREFIX" ]; then PREFIX="branches"; fi

          if [ -n "$PR" ]; then
            SUBDIR="pull/$PR"
            if [ "$PR_REF" = "merge" ]; then
              CHECKOUT_REF="refs/pull/$PR/merge"
            else
              CHECKOUT_REF="refs/pull/$PR/head"
            fi
            MODE="pr"
          else
            BRANCH="${{ github.ref_name }}"
            SAFE="$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9._-]+#-#g')"
            SUBDIR="$PREFIX/$SAFE"
            CHECKOUT_REF="${{ github.ref }}"   # refs/heads/<branch>
            MODE="branch"
          fi

          if [[ "$SUBDIR" == /* || "$SUBDIR" == *".."* || -z "$SUBDIR" ]]; then
            echo "Invalid subdir for destination_dir: '$SUBDIR'"
            exit 1
          fi

          echo "subdir=$SUBDIR" >> "$GITHUB_OUTPUT"
          echo "checkout_ref=$CHECKOUT_REF" >> "$GITHUB_OUTPUT"
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

  build-site:
    needs: vars
    uses: ./.github/workflows/build-site.yml
    with:
      deploy_subdir: ${{ needs.vars.outputs.subdir }}
      checkout_ref: ${{ needs.vars.outputs.checkout_ref }}

  build-demo:
    needs: vars
    uses: ./.github/workflows/build-demo.yml
    with:
      deploy_subdir: ${{ needs.vars.outputs.subdir }}
      checkout_ref: ${{ needs.vars.outputs.checkout_ref }}

  assemble-and-deploy:
    needs: [vars, build-site, build-demo]
    runs-on: ubuntu-latest
    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: pages

      - name: Download demo artifact
        uses: actions/download-artifact@v4
        with:
          name: demo-dist
          path: pages/demo

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./pages
          destination_dir: ${{ needs.vars.outputs.subdir }}
          keep_files: true

      - name: Print URLs
        shell: bash
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          subdir="${{ needs.vars.outputs.subdir }}"
          echo "Site: https://${owner}.github.io/${repo}/${subdir}/"
          echo "Demo: https://${owner}.github.io/${repo}/${subdir}/demo/"
