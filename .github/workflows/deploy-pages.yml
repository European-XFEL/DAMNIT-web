name: Deploy Pages

on:
  workflow_dispatch:
    inputs:
    folder_prefix:
      description: "Top-level folder (default: branches)."
      required: false
      default: "branches"

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: true

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      subdir: ${{ steps.v.outputs.subdir }}
      branch: ${{ steps.v.outputs.branch }}
    steps:
      - id: v
        shell: bash
        run: |
          BRANCH="${{ github.ref_name }}"
          SAFE="$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9._-]+#-#g')"
          PREFIX="${{ inputs.folder_prefix }}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "subdir=$PREFIX/$SAFE" >> "$GITHUB_OUTPUT"

  build-site:
    needs: vars
    uses: ./.github/workflows/build-site.yml
    with:
      deploy_subdir: ${{ needs.vars.outputs.subdir }}

  build-demo:
    needs: vars
    uses: ./.github/workflows/build-demo.yml
    with:
      deploy_subdir: ${{ needs.vars.outputs.subdir }}

  assemble-and-deploy:
    needs: [vars, build-site, build-demo]
    runs-on: ubuntu-latest
    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: pages

      - name: Download demo artifact
        uses: actions/download-artifact@v4
        with:
          name: demo-dist
          path: pages/demo

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./pages
          destination_dir: ${{ needs.vars.outputs.subdir }}
          keep_files: true

      - name: Print URLs
        shell: bash
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          subdir="${{ needs.vars.outputs.subdir }}"
          echo "Site: https://${owner}.github.io/${repo}/${subdir}/"
          echo "Demo: https://${owner}.github.io/${repo}/${subdir}/demo/"
